<div class="simulation-section">
    <div class="section-intro">
        <div class="intro-icon">
            <i class="fas fa-desktop fa-3x"></i>
        </div>
        <h2>Exact Differential Equation Solver</h2>
        <p class="section-description">
            Solve any exact differential equation step by step using the general solution method
        </p>
    </div>

    <div class="simulation-content">
        <!-- Equation Input Section -->
        <div class="input-section">
            <div class="input-card">
                <h3><i class="fas fa-keyboard"></i> Enter Your Exact Differential Equation</h3>
                <p>Enter equation in the form: M(x,y)dx + N(x,y)dy = 0</p>
                
                <div class="equation-input-container">
                    <div class="input-group">
                        <label for="equation-input">
                            <i class="fas fa-pencil-alt"></i> Enter Equation:
                        </label>
                        <input type="text" id="equation-input" 
                               placeholder="Example: (2x + y)dx + (x + 2y)dy = 0"
                               value="(2x + y)dx + (x + 2y)dy = 0">
                    </div>
                    
                    <div class="input-help">
                        <h5><i class="fas fa-lightbulb"></i> How to write equations:</h5>
                        <ul>
                            <li>Use * for multiplication: 2*x*y</li>
                            <li>Use ^ for exponents: x^2, y^3</li>
                            <li>Use sin(x), cos(x), exp(x), ln(x), log(x)</li>
                            <li>Use e for exponential constant</li>
                            <li>Use pi for π</li>
                            <li>Examples: (3*x^2 + sin(y))dx + (x^3 + y^2)dy = 0</li>
                        </ul>
                    </div>
                    
                    <div class="solve-actions">
                        <button id="solve-equation" class="solve-btn">
                            <i class="fas fa-calculator"></i> Solve Step-by-Step
                        </button>
                        <button id="clear-equation" class="clear-btn">
                            <i class="fas fa-redo"></i> Clear
                        </button>
                    </div>
                </div>
                
                <div class="quick-examples">
                    <h4><i class="fas fa-bolt"></i> Try These Examples:</h4>
                    <div class="example-buttons">
                        <button class="example-btn" data-eq="(2*x + y)*dx + (x + 2*y)*dy = 0">Simple</button>
                        <button class="example-btn" data-eq="(3*x^2 + y)*dx + (x + exp(y))*dy = 0">With exp</button>
                        <button class="example-btn" data-eq="(2*x*y + y^2)*dx + (x^2 + 2*x*y)*dy = 0">Polynomial</button>
                        <button class="example-btn" data-eq="(cos(x) + y)*dx + (x + sin(y))*dy = 0">Trigonometric</button>
                        <button class="example-btn" data-eq="(exp(x)*sin(y) - 2*y*sin(x))*dx + (exp(x)*cos(y) + 2*cos(x))*dy = 0">Complex</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Solution Display Area -->
        <div class="solution-section">
            <div id="steps-container">
                <div class="initial-state">
                    <div class="state-icon">
                        <i class="fas fa-calculator fa-4x"></i>
                    </div>
                    <h3>Ready to Solve Exact Differential Equations</h3>
                    <p>Enter an equation in the format: M(x,y)dx + N(x,y)dy = 0</p>
                    <p class="hint">Try one of the examples above to get started!</p>
                    
                    <div class="method-explanation">
                        <h4><i class="fas fa-book"></i> Method Overview:</h4>
                        <p>The general solution method for exact differential equations follows these steps:</p>
                        <ol>
                            <li>Identify M(x,y) and N(x,y) from the equation Mdx + Ndy = 0</li>
                            <li>Check exactness condition: ∂M/∂y = ∂N/∂x</li>
                            <li>If exact, integrate M with respect to x: F(x,y) = ∫M dx + g(y)</li>
                            <li>Differentiate F with respect to y: ∂F/∂y = ∂/∂y(∫M dx) + g'(y)</li>
                            <li>Set ∂F/∂y = N to find g'(y)</li>
                            <li>Integrate g'(y) to find g(y)</li>
                            <li>General solution: F(x,y) = C</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step-by-Step Guide -->
        <div class="guide-section">
            <h3><i class="fas fa-graduation-cap"></i> Step-by-Step Guide for Solving Exact DEs</h3>
            
            <div class="guide-steps">
                <div class="guide-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h5>Step 1: Identify M and N</h5>
                        <p>From the equation M(x,y)dx + N(x,y)dy = 0, extract M and N functions.</p>
                        <div class="math-example">
                            Example: (2x + y)dx + (x + 2y)dy = 0<br>
                            M = 2x + y, N = x + 2y
                        </div>
                    </div>
                </div>
                
                <div class="guide-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h5>Step 2: Check Exactness</h5>
                        <p>Compute partial derivatives ∂M/∂y and ∂N/∂x. If equal, the equation is exact.</p>
                        <div class="math-example">
                            ∂M/∂y = ∂/∂y(2x + y) = 1<br>
                            ∂N/∂x = ∂/∂x(x + 2y) = 1<br>
                            Since ∂M/∂y = ∂N/∂x, the equation is exact.
                        </div>
                    </div>
                </div>
                
                <div class="guide-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h5>Step 3: Integrate M with respect to x</h5>
                        <p>Integrate M treating y as constant. Add an arbitrary function g(y).</p>
                        <div class="math-example">
                            F(x,y) = ∫M dx = ∫(2x + y) dx = x² + xy + g(y)
                        </div>
                    </div>
                </div>
                
                <div class="guide-step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <h5>Step 4: Differentiate with respect to y</h5>
                        <p>Differentiate F with respect to y to get ∂F/∂y.</p>
                        <div class="math-example">
                            ∂F/∂y = ∂/∂y(x² + xy + g(y)) = x + g'(y)
                        </div>
                    </div>
                </div>
                
                <div class="guide-step">
                    <div class="step-number">5</div>
                    <div class="step-content">
                        <h5>Step 5: Compare with N to find g'(y)</h5>
                        <p>Set ∂F/∂y = N and solve for g'(y).</p>
                        <div class="math-example">
                            x + g'(y) = x + 2y ⇒ g'(y) = 2y
                        </div>
                    </div>
                </div>
                
                <div class="guide-step">
                    <div class="step-number">6</div>
                    <div class="step-content">
                        <h5>Step 6: Integrate g'(y)</h5>
                        <p>Integrate g'(y) with respect to y to find g(y).</p>
                        <div class="math-example">
                            g(y) = ∫2y dy = y² + C₁
                        </div>
                    </div>
                </div>
                
                <div class="guide-step">
                    <div class="step-number">7</div>
                    <div class="step-content">
                        <h5>Step 7: Write General Solution</h5>
                        <p>Combine to get the general solution F(x,y) = C.</p>
                        <div class="math-example">
                            x² + xy + y² = C (where C is constant)
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Enhanced Simulation Styles */
.simulation-section {
    padding: 20px 0;
}

.input-section {
    margin-bottom: 40px;
}

.input-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 30px;
    box-shadow: var(--shadow-light);
    border-left: 4px solid var(--primary-color);
}

.equation-input-container {
    margin: 25px 0;
}

.input-group label {
    display: block;
    margin-bottom: 10px;
    font-weight: 600;
    color: var(--secondary-color);
    display: flex;
    align-items: center;
    gap: 10px;
}

#equation-input {
    width: 100%;
    padding: 15px;
    font-size: 18px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    transition: var(--transition);
    background: #f8f9fa;
}

#equation-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    background: white;
}

.input-help {
    background: #f0f7ff;
    padding: 20px;
    border-radius: 6px;
    margin: 20px 0;
    border-left: 3px solid var(--primary-color);
}

.input-help ul {
    list-style: none;
    margin-top: 10px;
}

.input-help li {
    padding: 5px 0;
    color: var(--text-gray);
}

.input-help li:before {
    content: '•';
    color: var(--primary-color);
    font-weight: bold;
    display: inline-block;
    width: 20px;
}

.solve-actions {
    display: flex;
    gap: 15px;
    margin-top: 25px;
}

.solve-btn, .clear-btn {
    padding: 15px 30px;
    font-size: 16px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: var(--transition);
    border: none;
}

.solve-btn {
    flex: 2;
    background: linear-gradient(45deg, var(--primary-color), var(--primary-dark));
    color: white;
}

.solve-btn:hover {
    background: linear-gradient(45deg, var(--primary-dark), var(--secondary-color));
    transform: translateY(-3px);
    box-shadow: var(--shadow-medium);
}

.clear-btn {
    flex: 1;
    background: var(--light-bg);
    color: var(--secondary-color);
    border: 1px solid var(--border-color);
}

.clear-btn:hover {
    background: var(--border-color);
    transform: translateY(-3px);
}

.quick-examples {
    margin-top: 30px;
    padding-top: 25px;
    border-top: 1px solid var(--border-color);
}

.example-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
}

.example-btn {
    padding: 10px 20px;
    background: var(--light-bg);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    cursor: pointer;
    transition: var(--transition);
    font-size: 14px;
}

.example-btn:hover {
    background: var(--primary-color);
    color: white;
    transform: translateY(-2px);
}

/* Solution Section */
.solution-section {
    background: white;
    border-radius: var(--border-radius);
    padding: 30px;
    margin-bottom: 40px;
    box-shadow: var(--shadow-light);
    min-height: 400px;
}

.initial-state {
    text-align: center;
    padding: 50px 20px;
}

.state-icon {
    color: var(--primary-color);
    margin-bottom: 20px;
    opacity: 0.5;
}

.method-explanation {
    text-align: left;
    max-width: 800px;
    margin: 40px auto 0;
    padding: 25px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid var(--primary-color);
}

.method-explanation ol {
    list-style-position: inside;
    margin-top: 15px;
}

.method-explanation li {
    padding: 8px 0;
    color: var(--text-gray);
}

/* Guide Section */
.guide-section {
    background: #f8f9fa;
    padding: 40px 30px;
    border-radius: var(--border-radius);
    margin-top: 40px;
}

.guide-steps {
    display: flex;
    flex-direction: column;
    gap: 30px;
    margin-top: 30px;
}

.guide-step {
    display: flex;
    gap: 25px;
    padding: 25px;
    background: white;
    border-radius: 8px;
    border-left: 4px solid var(--primary-color);
    box-shadow: var(--shadow-light);
    transition: var(--transition);
}

.guide-step:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-medium);
}

.step-number {
    width: 50px;
    height: 50px;
    background: linear-gradient(45deg, var(--primary-color), var(--primary-dark));
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
    flex-shrink: 0;
}

.step-content {
    flex: 1;
}

.step-content h5 {
    margin-bottom: 10px;
    color: var(--secondary-color);
}

.math-example {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
    margin-top: 15px;
    font-family: 'Cambria Math', serif;
    font-size: 16px;
    border: 1px solid #e9ecef;
}

/* Solution Display Styles */
.solution-header {
    padding: 25px;
    background: linear-gradient(135deg, #f0f7ff, #e3f2fd);
    border-radius: 8px;
    margin-bottom: 30px;
    border-left: 5px solid var(--primary-color);
}

.solution-header h3 {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 10px;
}

.steps-timeline {
    position: relative;
    padding-left: 30px;
    margin: 40px 0;
}

.steps-timeline:before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: linear-gradient(to bottom, var(--primary-color), var(--success-color));
    border-radius: 2px;
}

.step-card {
    position: relative;
    background: white;
    border-radius: 8px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: var(--shadow-light);
    border: 1px solid #e9ecef;
    transition: var(--transition);
}

.step-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-medium);
}

.step-card:before {
    content: '';
    position: absolute;
    left: -38px;
    top: 40px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--primary-color);
    border: 4px solid white;
    box-shadow: 0 0 0 4px var(--primary-color);
}

.step-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 2px solid #f0f7ff;
}

.step-number {
    width: 40px;
    height: 40px;
    background: linear-gradient(45deg, var(--primary-color), var(--primary-dark));
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 18px;
    flex-shrink: 0;
}

.step-header h5 {
    margin: 0;
    color: var(--secondary-color);
    font-size: 20px;
}

.step-content {
    margin-left: 60px;
}

.step-equation {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 6px;
    font-family: 'Cambria Math', 'Times New Roman', serif;
    font-size: 18px;
    margin: 15px 0;
    border-left: 4px solid var(--primary-color);
    overflow-x: auto;
}

.step-explanation {
    color: var(--text-gray);
    line-height: 1.8;
    margin: 15px 0;
    padding-left: 20px;
    border-left: 3px solid #e9ecef;
}

.step-details {
    background: #f0f7ff;
    padding: 20px;
    border-radius: 6px;
    margin-top: 20px;
    border: 1px solid #d1ecf1;
}

.step-details h6 {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    color: var(--secondary-color);
}

.step-details ul {
    list-style: none;
    margin: 0;
    padding: 0;
}

.step-details li {
    padding: 8px 0;
    padding-left: 25px;
    position: relative;
    color: var(--text-gray);
}

.step-details li:before {
    content: '→';
    position: absolute;
    left: 0;
    color: var(--primary-color);
    font-weight: bold;
}

/* Exactness Result */
.exactness-result {
    padding: 25px;
    border-radius: 8px;
    margin: 20px 0;
    animation: slideIn 0.5s ease;
}

.exactness-result.exact {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
    border-left: 5px solid #28a745;
}

.exactness-result.not-exact {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
    border-left: 5px solid #dc3545;
}

.exactness-result .result-icon {
    font-size: 32px;
    margin-bottom: 15px;
}

.exactness-result h4 {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

/* Integration Steps */
.integration-step {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 6px;
    margin: 20px 0;
    border: 1px solid #e9ecef;
}

.integration-step h6 {
    color: var(--secondary-color);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Final Solution */
.final-solution {
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    padding: 30px;
    border-radius: 8px;
    margin: 40px 0;
    text-align: center;
    border: 2px solid #28a745;
    animation: pulse 2s infinite;
}

.final-solution h4 {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
    color: #155724;
}

.final-solution-equation {
    font-family: 'Cambria Math', serif;
    font-size: 24px;
    color: #155724;
    font-weight: bold;
    padding: 20px;
    background: white;
    border-radius: 6px;
    display: inline-block;
    margin: 10px 0;
}

/* Error States */
.error-message {
    text-align: center;
    padding: 50px 20px;
    color: var(--accent-color);
}

.error-message i {
    font-size: 48px;
    margin-bottom: 20px;
    opacity: 0.7;
}

/* Animations */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
}

/* Responsive */
@media (max-width: 768px) {
    .guide-step {
        flex-direction: column;
        gap: 20px;
    }
    
    .step-number {
        align-self: flex-start;
    }
    
    .solve-actions {
        flex-direction: column;
    }
    
    .step-content {
        margin-left: 0;
    }
    
    .steps-timeline {
        padding-left: 20px;
    }
    
    .step-card:before {
        left: -28px;
    }
}
</style>

<script>
// Main solver function for exact differential equations
async function solveExactDE() {
    const equationInput = document.getElementById('equation-input');
    const stepsContainer = document.getElementById('steps-container');
    
    if (!equationInput || !stepsContainer) return;
    
    const equation = equationInput.value.trim();
    
    if (!equation) {
        showAlert('Please enter a differential equation in the form M(x,y)dx + N(x,y)dy = 0', 'warning');
        return;
    }
    
    // Clear previous results
    stepsContainer.innerHTML = `
        <div class="loading-state">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
            <h3>Solving Equation...</h3>
            <p>Parsing and analyzing the differential equation</p>
        </div>
    `;
    
    try {
        // Parse the equation
        const parsedEquation = parseDifferentialEquation(equation);
        
        if (!parsedEquation.success) {
            throw new Error(parsedEquation.error);
        }
        
        const { M, N, M_str, N_str } = parsedEquation;
        
        // Generate solution steps
        const solution = await solveExactDifferentialEquation(M, N, M_str, N_str);
        
        // Display the solution
        displaySolutionSteps(solution, stepsContainer);
        
        // Scroll to solution
        stepsContainer.scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        console.error('Error solving equation:', error);
        stepsContainer.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-triangle fa-3x"></i>
                <h3>Error Solving Equation</h3>
                <p>${error.message}</p>
                <p class="hint">Please check your equation format and try again.</p>
                <button class="retry-btn" onclick="solveExactDE()">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        `;
    }
}

// Parse differential equation to extract M and N
function parseDifferentialEquation(equation) {
    try {
        // Remove spaces
        equation = equation.replace(/\s/g, '');
        
        // Check if equation ends with = 0
        if (!equation.endsWith('=0')) {
            throw new Error('Equation must be in the form Mdx + Ndy = 0');
        }
        
        // Remove =0 from the end
        equation = equation.slice(0, -2);
        
        // Split by dx and dy
        const parts = equation.split('dx');
        
        if (parts.length !== 2) {
            throw new Error('Could not find Mdx term. Use format: M(x,y)dx + N(x,y)dy');
        }
        
        let M_str = parts[0];
        let rest = parts[1];
        
        // Check for + or - sign before N
        let sign = '+';
        if (rest.startsWith('+') || rest.startsWith('-')) {
            sign = rest[0];
            rest = rest.substring(1);
        }
        
        // Split by dy
        const nParts = rest.split('dy');
        
        if (nParts.length !== 2 || nParts[1] !== '') {
            throw new Error('Could not find Ndy term. Use format: M(x,y)dx + N(x,y)dy');
        }
        
        let N_str = nParts[0];
        
        // Add sign to N if needed
        if (sign === '-') {
            N_str = '-' + N_str;
        }
        
        // Remove outer parentheses if present
        M_str = M_str.replace(/^\(|\)$/g, '');
        N_str = N_str.replace(/^\(|\)$/g, '');
        
        // Validate that M and N contain only valid characters
        const validChars = /^[0-9xyeEπ\.\+\-\*\/\^\(\)sincostanexpcoslnlog]+$/;
        
        if (!validChars.test(M_str) || !validChars.test(N_str)) {
            throw new Error('Invalid characters in M or N. Use only x, y, numbers, +, -, *, /, ^, sin, cos, tan, exp, ln, log');
        }
        
        // Parse using math.js
        const M = math.parse(M_str);
        const N = math.parse(N_str);
        
        return {
            success: true,
            M: M,
            N: N,
            M_str: M_str,
            N_str: N_str
        };
        
    } catch (error) {
        return {
            success: false,
            error: error.message
        };
    }
}

// Solve exact differential equation step by step
async function solveExactDifferentialEquation(M, N, M_str, N_str) {
    const steps = [];
    
    // Step 1: Identify M and N
    steps.push({
        title: "Step 1: Identify M(x,y) and N(x,y)",
        equation: `Given: ${M_str} dx + ${N_str} dy = 0`,
        explanation: "From the given differential equation, we extract M and N functions.",
        details: [
            `M(x, y) = ${M_str}`,
            `N(x, y) = ${N_str}`
        ]
    });
    
    // Step 2: Compute partial derivatives
    let dM_dy, dN_dx;
    try {
        dM_dy = math.derivative(M, 'y');
        dN_dx = math.derivative(N, 'x');
    } catch (error) {
        throw new Error('Error computing partial derivatives: ' + error.message);
    }
    
    const dM_dy_str = dM_dy.toString();
    const dN_dx_str = dN_dx.toString();
    
    steps.push({
        title: "Step 2: Compute Partial Derivatives",
        equation: `Compute ∂M/∂y and ∂N/∂x`,
        explanation: "We need to check if the equation is exact by comparing partial derivatives.",
        details: [
            `∂M/∂y = ∂/∂y(${M_str}) = ${dM_dy_str}`,
            `∂N/∂x = ∂/∂x(${N_str}) = ${dN_dx_str}`
        ]
    });
    
    // Step 3: Check exactness
    const isExact = math.simplify(dM_dy.toString() + ' - (' + dN_dx.toString() + ')').toString() === '0';
    
    steps.push({
        title: "Step 3: Check Exactness Condition",
        equation: `Condition: ∂M/∂y = ∂N/∂x`,
        explanation: `We compare the computed partial derivatives to determine if the equation is exact.`,
        details: [
            `∂M/∂y = ${dM_dy_str}`,
            `∂N/∂x = ${dN_dx_str}`,
            `Difference: ∂M/∂y - ∂N/∂x = ${math.simplify(dM_dy.subtract(dN_dx)).toString()}`
        ],
        isExact: isExact
    });
    
    if (!isExact) {
        return {
            steps: steps,
            isExact: false,
            message: "The equation is not exact because ∂M/∂y ≠ ∂N/∂x."
        };
    }
    
    // Step 4: Integrate M with respect to x
    let F_x;
    try {
        F_x = math.integrate(M, 'x');
    } catch (error) {
        throw new Error('Error integrating M with respect to x: ' + error.message);
    }
    
    const F_x_str = F_x.toString();
    
    steps.push({
        title: "Step 4: Integrate M with respect to x",
        equation: `F(x, y) = ∫ M dx = ∫ (${M_str}) dx`,
        explanation: "We integrate M with respect to x, treating y as constant. We add an arbitrary function g(y).",
        details: [
            `∫ (${M_str}) dx = ${F_x_str}`,
            `Therefore, F(x, y) = ${F_x_str} + g(y)`
        ]
    });
    
    // Step 5: Differentiate F with respect to y
    let dF_dy;
    try {
        dF_dy = math.derivative(F_x, 'y');
    } catch (error) {
        throw new Error('Error differentiating F with respect to y: ' + error.message);
    }
    
    const dF_dy_str = dF_dy.toString();
    
    steps.push({
        title: "Step 5: Differentiate F with respect to y",
        equation: `∂F/∂y = ∂/∂y[${F_x_str}] + g'(y)`,
        explanation: "We differentiate F(x,y) with respect to y. Remember that g(y) is an arbitrary function of y.",
        details: [
            `∂/∂y[${F_x_str}] = ${dF_dy_str}`,
            `Therefore, ∂F/∂y = ${dF_dy_str} + g'(y)`
        ]
    });
    
    // Step 6: Find g'(y) by comparing with N
    let g_prime;
    try {
        g_prime = math.simplify(math.parse(N_str + ' - (' + dF_dy_str + ')'));
    } catch (error) {
        throw new Error('Error finding g\'(y): ' + error.message);
    }
    
    const g_prime_str = g_prime.toString();
    
    steps.push({
        title: "Step 6: Find g'(y) by comparing with N",
        equation: `Since ∂F/∂y must equal N(x,y)`,
        explanation: "We set the derivative ∂F/∂y equal to N(x,y) and solve for g'(y).",
        details: [
            `∂F/∂y = N(x,y)`,
            `${dF_dy_str} + g'(y) = ${N_str}`,
            `g'(y) = ${N_str} - (${dF_dy_str})`,
            `g'(y) = ${g_prime_str}`
        ]
    });
    
    // Step 7: Integrate g'(y) to find g(y)
    let g_y;
    try {
        g_y = math.integrate(g_prime, 'y');
    } catch (error) {
        throw new Error('Error integrating g\'(y): ' + error.message);
    }
    
    const g_y_str = g_y.toString();
    
    steps.push({
        title: "Step 7: Integrate g'(y) to find g(y)",
        equation: `g(y) = ∫ g'(y) dy = ∫ (${g_prime_str}) dy`,
        explanation: "We integrate g'(y) with respect to y to find the arbitrary function g(y).",
        details: [
            `∫ (${g_prime_str}) dy = ${g_y_str}`,
            `g(y) = ${g_y_str} + C₁ (where C₁ is constant)`
        ]
    });
    
    // Step 8: Write the general solution
    let final_solution;
    try {
        final_solution = math.simplify(math.parse(F_x_str + ' + (' + g_y_str + ')'));
    } catch (error) {
        final_solution = F_x_str + ' + ' + g_y_str;
    }
    
    steps.push({
        title: "Step 8: Write the General Solution",
        equation: `F(x, y) = C`,
        explanation: "The general solution of the exact differential equation is F(x,y) = C, where C is an arbitrary constant.",
        details: [
            `F(x, y) = ${F_x_str} + g(y)`,
            `= ${F_x_str} + (${g_y_str})`,
            `= ${final_solution.toString()}`
        ]
    });
    
    return {
        steps: steps,
        isExact: true,
        solution: `${final_solution.toString()} = C`,
        final_solution: final_solution.toString()
    };
}

// Display solution steps
function displaySolutionSteps(solution, container) {
    let html = '';
    
    if (!solution.isExact) {
        html = `
            <div class="solution-header">
                <h3><i class="fas fa-cogs"></i> Step-by-Step Analysis</h3>
                <p>The equation is not exact. Here's the analysis:</p>
            </div>
            
            <div class="steps-timeline">
                ${solution.steps.map((step, index) => `
                    <div class="step-card">
                        <div class="step-header">
                            <span class="step-number">${index + 1}</span>
                            <h5>${step.title}</h5>
                        </div>
                        <div class="step-content">
                            <div class="step-equation">${step.equation}</div>
                            <p class="step-explanation">${step.explanation}</p>
                            ${step.details ? `
                                <div class="step-details">
                                    <h6><i class="fas fa-info-circle"></i> Details:</h6>
                                    <ul>
                                        ${step.details.map(detail => `<li>${detail}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div class="exactness-result not-exact">
                <div class="result-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
                <h4><i class="fas fa-exclamation-triangle"></i> Equation is NOT Exact</h4>
                <p>Since ∂M/∂y ≠ ∂N/∂x, this differential equation is not exact.</p>
                <p><strong>What you can do:</strong></p>
                <ul>
                    <li>Check if there's a typo in your equation</li>
                    <li>Try using an integrating factor to make it exact</li>
                    <li>Verify if the equation can be solved by other methods (separable, linear, etc.)</li>
                </ul>
            </div>
        `;
    } else {
        html = `
            <div class="solution-header">
                <h3><i class="fas fa-cogs"></i> Step-by-Step Solution of Exact Differential Equation</h3>
                <p>The equation is exact. Following the general solution method:</p>
            </div>
            
            <div class="exactness-result exact">
                <div class="result-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h4><i class="fas fa-check"></i> Equation is EXACT</h4>
                <p>Since ∂M/∂y = ∂N/∂x, we can solve using the exact differential equation method.</p>
            </div>
            
            <div class="steps-timeline">
                ${solution.steps.map((step, index) => `
                    <div class="step-card">
                        <div class="step-header">
                            <span class="step-number">${index + 1}</span>
                            <h5>${step.title}</h5>
                        </div>
                        <div class="step-content">
                            <div class="step-equation">${step.equation}</div>
                            <p class="step-explanation">${step.explanation}</p>
                            ${step.details ? `
                                <div class="step-details">
                                    <h6><i class="fas fa-info-circle"></i> Details:</h6>
                                    <ul>
                                        ${step.details.map(detail => `<li>${detail}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div class="final-solution">
                <h4><i class="fas fa-trophy"></i> General Solution</h4>
                <div class="final-solution-equation">${solution.solution}</div>
                <p>Where C is an arbitrary constant of integration.</p>
                <p class="hint">This is the complete family of solutions to the exact differential equation.</p>
                
                <div class="verification-note">
                    <h5><i class="fas fa-check-double"></i> Verification:</h5>
                    <p>To verify, differentiate the solution implicitly and check if it satisfies the original equation.</p>
                </div>
            </div>
            
            <div class="additional-notes">
                <h4><i class="fas fa-lightbulb"></i> Important Notes:</h4>
                <ul>
                    <li>The solution represents a family of curves parameterized by C</li>
                    <li>For a particular solution, you need an initial condition</li>
                    <li>You can verify by substituting back into the original equation</li>
                    <li>If you get a particular initial condition, substitute to find specific C</li>
                </ul>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// Initialize simulation functionality
document.addEventListener('DOMContentLoaded', function() {
    // Setup example buttons
    document.querySelectorAll('.example-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const equation = this.getAttribute('data-eq');
            document.getElementById('equation-input').value = equation;
        });
    });
    
    // Setup solve button
    const solveBtn = document.getElementById('solve-equation');
    if (solveBtn) {
        solveBtn.addEventListener('click', solveExactDE);
    }
    
    // Setup clear button
    const clearBtn = document.getElementById('clear-equation');
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            document.getElementById('equation-input').value = '';
            document.getElementById('steps-container').innerHTML = `
                <div class="initial-state">
                    <div class="state-icon">
                        <i class="fas fa-calculator fa-4x"></i>
                    </div>
                    <h3>Ready to Solve Exact Differential Equations</h3>
                    <p>Enter an equation in the format: M(x,y)dx + N(x,y)dy = 0</p>
                    <p class="hint">Try one of the examples above to get started!</p>
                </div>
            `;
        });
    }
    
    // Add enter key support
    const equationInput = document.getElementById('equation-input');
    if (equationInput) {
        equationInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                solveExactDE();
            }
        });
    }
});

// Helper function to show alerts
function showAlert(message, type = 'info') {
    // Remove existing alerts
    const existingAlert = document.querySelector('.custom-alert');
    if (existingAlert) existingAlert.remove();
    
    // Create alert element
    const alert = document.createElement('div');
    alert.className = `custom-alert alert-${type}`;
    alert.innerHTML = `
        <i class="fas fa-${getAlertIcon(type)}"></i>
        <span>${message}</span>
        <button class="alert-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Add to page
    document.body.appendChild(alert);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alert.parentElement) {
            alert.remove();
        }
    }, 5000);
}

function getAlertIcon(type) {
    const icons = {
        'success': 'check-circle',
        'error': 'exclamation-circle',
        'warning': 'exclamation-triangle',
        'info': 'info-circle'
    };
    return icons[type] || 'info-circle';
}
</script>

<style>
/* Alert Styles */
.custom-alert {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 15px;
    z-index: 2000;
    animation: slideInRight 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    max-width: 400px;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border-left: 4px solid #28a745;
}

.alert-error {
    background: #f8d7da;
    color: #721c24;
    border-left: 4px solid #dc3545;
}

.alert-warning {
    background: #fff3cd;
    color: #856404;
    border-left: 4px solid #ffc107;
}

.alert-info {
    background: #d1ecf1;
    color: #0c5460;
    border-left: 4px solid #17a2b8;
}

.alert-close {
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    padding: 0;
    margin-left: auto;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Loading State */
.loading-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--primary-color);
}

.loading-state i {
    margin-bottom: 20px;
}

/* Additional Notes */
.additional-notes {
    background: #f0f7ff;
    padding: 25px;
    border-radius: 8px;
    margin-top: 30px;
    border-left: 4px solid var(--primary-color);
}

.additional-notes ul {
    list-style: none;
    margin-top: 15px;
}

.additional-notes li {
    padding: 10px 0;
    padding-left: 30px;
    position: relative;
    color: var(--text-gray);
}

.additional-notes li:before {
    content: '✓';
    position: absolute;
    left: 0;
    color: var(--primary-color);
    font-weight: bold;
}

.verification-note {
    margin-top: 20px;
    padding: 20px;
    background: white;
    border-radius: 6px;
    border: 1px solid #e9ecef;
}

.retry-btn {
    margin-top: 20px;
    padding: 10px 25px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 10px;
}
</style>
